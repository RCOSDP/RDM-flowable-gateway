# asice-cli

`asice-cli` bridges Flowable Gateway and downstream storage by providing a focused CLI for ASiC-E containers. It offers two subcommands: `package`, which builds signed `.asice` archives with RFC 3161 timestamps, and `verify`, which validates existing archives before handing them to other services.

## Specification
### `asice-cli package`
```
asice-cli package [OPTIONS] [FILE]...
```
- `--key PATH` (required): PEM encoded private key for PKCS#7 signing.
- `--cert PATH` (required): PEM encoded certificate paired with `--key`.
- `--tsa-url URL` (required): RFC 3161 Time Stamp Authority endpoint provided by Flowable configuration.
- `--tsa-cert PATH` (required): Certificate bundle for validating the TSA response. No default is assumed.
- `--output PATH` (optional): Destination `.asice`. When omitted, the archive is streamed to stdout as raw bytes.
- `--verbose` / `--quiet` (optional): Control log verbosity; diagnostics always reach stderr on failure.
- `[FILE]...` (one or more): Files to embed at the archive root. Each path must resolve to a readable regular file. Filenames must be unique after flattening (duplicates are rejected to keep the container deterministic).

Output contract:
- Payload files appear at the ZIP root in the order provided and are stored without compression.
- `mimetype` is stored uncompressed as the first entry and contains `application/vnd.etsi.asic-e+zip`.
- `META-INF/ASiCManifest.xml` lists each payload (SHA-256) and references the detached signature via `SigReference` so ASiC-E validators can treat the archive as CAdES-based.
- `META-INF/ASiCManifest-timestamp*.xml` mirror the payload list but reference `META-INF/timestamp*.tst` time-assertions. Packaging emits the base `ASiCManifest-timestamp.xml`, while future re-timestamps append new files following the same pattern.
- `META-INF/signatures.p7s` is a DER CAdES-BES signature (produced via `openssl cms -sign -cades`) over `ASiCManifest.xml`.
- `META-INF/timestamp*.tst` contain RFC 3161 tokens applied to the corresponding timestamp manifests.
- Incomplete archives are never emitted. Any error raises a non-zero exit code.

### `asice-cli verify`
```
asice-cli verify [OPTIONS] ARCHIVE
```
- `ARCHIVE` (required): Path to an `.asice` file produced by Flowable/`asice-cli package`.
- `--signer-cert PATH` (required): PEM file or bundle used to validate the PKCS#7 signature.
- `--tsa-cert PATH` (required): Certificate bundle for validating the RFC 3161 timestamp token.
- `--report json` (optional): Emit a JSON report to stdout containing payload digests, signer certificate path, and timestamp token metadata (name/size/time) in addition to the exit code.
- `--verbose` / `--quiet`: Same semantics as `package`.

Verification steps:
1. Parse every `META-INF/ASiCManifest*.xml`, ensure each payload listed exists at the archive root, recompute SHA-256 digests, and reject extra payload files outside `META-INF`/`mimetype`.
2. For each manifest whose `SigReference` targets `*signature*.p7s`, extract that signature and run `openssl cms -verify` with the supplied signer certificate.
3. For each manifest whose `SigReference` targets `*timestamp*.tst`, extract the RFC 3161 token and run `openssl ts -verify` against the manifest bytes using the TSA certificate.
4. If `--report json` is set, output a JSON object with the verified payload list plus the signature/timestamp manifest metadata.
5. Exit with code `0` on success, otherwise fail fast with exit code `74` and the offending reason on stderr.

### `asice-cli retimestamp`
```
asice-cli retimestamp [OPTIONS] ARCHIVE
```
- `ARCHIVE` (required): Existing `.asice` generated by `asice-cli package`.
- `--tsa-url URL` (required): RFC 3161 endpoint used for the new timestamp.
- `--tsa-cert PATH` (required): Certificate bundle for validating the new TSA response.
- `--output PATH` (optional): Destination `.asice`. When omitted the updated archive is streamed to stdout.
- `--signer-cert PATH` (optional but recommended): Certificate bundle for validating the existing `signatures.p7s` and its timestamp before extending.
- `--max-age DAYS` (optional): Skip re-timestamping when the most recent token is younger than the specified number of days.
- `--force` (optional): Ignore `--max-age` and always extend the timestamp.
- `--verbose` / `--quiet`: Same semantics as other subcommands.

Retimestamp flow:
1. Ensure at least one `META-INF/ASiCManifest*.xml` references `signatures.p7s` and at least one `META-INF/timestamp*.tst` exists.
2. If `--signer-cert` is provided, verify the signature manifest and the base timestamp manifest (`ASiCManifest-timestamp.xml` â†” `META-INF/timestamp.tst`) before proceeding.
3. When `--max-age` is set (and `--force` is not), inspect the latest timestamp token time and skip the operation if it is still within the allowed age.
   The command exits with status `0` and does not emit a new archive in that case.
4. Build a new timestamp manifest mirroring the payload list while referencing a fresh `META-INF/timestamp-<ISO8601>.tst`, request a TSA token over that manifest, and verify it with the supplied TSA certificate.
5. Copy every entry from the original archive unchanged and append the new manifest/token pair. Older manifests and tokens are retained for auditing.
6. Write the updated archive to `--output` or stdout, exit with code `0`, and reuse the same error codes (`64`, `70`, `74`) for invalid input, internal failures, or TSA issues.

### Exit codes
- `0`: success.
- `64`: usage error (missing flags, unreadable inputs, duplicate filenames, manifest mismatch, etc.).
- `70`: packaging or signature verification failure attributable to software bugs.
- `74`: I/O/TSA failures or timestamp validation issues.

### Logging & temp files
- Logs go to stderr; stdout is reserved for archive bytes when packaging without `--output`.
- Temporary files live under `$TMPDIR` and are cleaned even when errors occur.

## Repository Layout
```
asice_cli/
  __init__.py
  cli.py
  core.py
  tsa.py
certs/
  langedge-root.pem
README.md
pyproject.toml
Dockerfile
tests/
  test_cli.py
```
